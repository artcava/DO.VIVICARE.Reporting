name: CI/CD Pipeline

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
      - 'plugin/*'
  pull_request:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  checks: write
  pull-requests: write

jobs:
  # ========================================
  # JOB 1: BUILD & TEST (sempre eseguito)
  # ========================================
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.2.0

    - name: Restore NuGet packages
      run: nuget restore DO.VIVICARE.Reporting.sln

    - name: Build solution
      run: |
        msbuild DO.VIVICARE.Reporting.sln `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /maxcpucount
      shell: powershell

    - name: Run Unit Tests (optional)
      run: |
        $testProject = "DO.VIVICARE.Tests/DO.VIVICARE.Tests.csproj"
        if (Test-Path $testProject) {
          dotnet test $testProject `
            --configuration Release `
            --no-build `
            --logger "console;verbosity=detailed" `
            --logger "trx;LogFileName=test-results.trx"
        } else {
          Write-Host "Unit Test project not found, skipping..."
        }
      continue-on-error: true
      shell: powershell

    - name: Run Integration Tests (optional)
      run: |
        $testProject = "DO.VIVICARE.IntegrationTests/DO.VIVICARE.IntegrationTests.csproj"
        if (Test-Path $testProject) {
          dotnet test $testProject `
            --configuration Release `
            --no-build `
            --logger "console;verbosity=detailed" `
            --logger "trx;LogFileName=integration-test-results.trx"
        } else {
          Write-Host "Integration Test project not found, skipping..."
        }
      continue-on-error: true
      shell: powershell

    - name: Upload test results (if available)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/test-results*.trx'
      continue-on-error: true

    - name: Publish test results (if available)
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: '**/test-results*.trx'
        reporter: 'dotnet-trx'
      continue-on-error: true

    # Upload build artifacts per i job successivi
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          **/bin/Release/**/*.dll
          **/bin/Release/**/*.exe
          **/bin/Release/**/*.pdb
        retention-days: 1

  # ========================================
  # JOB 2: RELEASE APP (solo se tag v*.*...*)
  # ========================================
  release-app:
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'plugin')
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output

    - name: Extract version from tag
      id: version
      shell: powershell
      run: |
        $tag = "${{ github.ref }}"
        Write-Host "Processing tag: $tag"
        
        if ($tag -match "refs/tags/v(.*)$") {
          $version = $matches[1]
          Write-Host "Version extracted: $version"
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Invalid tag format"
          exit 1
        }

    - name: Update manifest.json
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $now = Get-Date -Format "yyyy-MM-dd"
        
        $manifest = @{
          version = $version
          releaseDate = $now
          testedWith = "CI/CD Pipeline - Build Successful"
          assets = @(
            @{
              type = "ui"
              name = "DO.VIVICARE.UI"
              version = $version
              file = "DO.VIVICARE-Setup-$version.zip"
              size = "15MB"
              minFramework = "4.8"
              checksum = ""
            }
          )
        }
        
        $json = $manifest | ConvertTo-Json -Depth 10
        Set-Content -Path "manifest.json" -Value $json -Encoding UTF8
        
        Write-Host "Manifest updated:"
        Write-Host $json

    - name: Create application package
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # Create package directory
        New-Item -ItemType Directory -Force -Path "package" | Out-Null
        
        # Copy UI binaries from downloaded artifacts
        if (Test-Path "DO.VIVICARE.UI/bin/Release") {
          Copy-Item "DO.VIVICARE.UI/bin/Release/*" -Destination "package/" -Force -Recurse
          Write-Host "Copied UI binaries"
        } else {
          Write-Error "UI binaries not found in artifacts"
          exit 1
        }
        
        # Copy Reporter binaries if available
        if (Test-Path "DO.VIVICARE.Reporter/bin/Release") {
          Copy-Item "DO.VIVICARE.Reporter/bin/Release/*" -Destination "package/" -Force -Recurse
          Write-Host "Copied Reporter binaries"
        }
        
        # Create ZIP
        Compress-Archive -Path "package/*" -DestinationPath "DO.VIVICARE-Setup-$version.zip" -Force
        Write-Host "Package created: DO.VIVICARE-Setup-$version.zip"
        
        # Get file size
        $fileSize = (Get-Item "DO.VIVICARE-Setup-$version.zip").Length / 1MB
        Write-Host "File size: $([Math]::Round($fileSize, 2)) MB"

    - name: Generate checksum
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $fileName = "DO.VIVICARE-Setup-$version.zip"
        
        Write-Host "Computing SHA256 checksum..."
        $checksum = (Get-FileHash $fileName -Algorithm SHA256).Hash
        echo "$checksum  $fileName" | Out-File -Encoding ASCII "CHECKSUM.txt"
        
        # Update manifest with checksum
        $manifest = Get-Content "manifest.json" | ConvertFrom-Json
        $manifest.assets[0].checksum = "sha256:$checksum"
        $manifest | ConvertTo-Json -Depth 10 | Set-Content "manifest.json"
        
        Write-Host "Checksum generated and added to manifest"
        Write-Host "SHA256: $checksum"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip
          CHECKSUM.txt
          manifest.json
        body: |
          # DO.VIVICARE Reporting v${{ steps.version.outputs.version }}
          
          **Status:** Build successful
          
          ## What's Included
          - UI Application v${{ steps.version.outputs.version }}
          - Reporter Library
          - Plugin Manager (automatic library updates)
          - SHA256 Checksum verification
          
          ## Installation
          
          ### Option 1: Semi-Automatic (Recommended)
          1. Download `DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip`
          2. Extract and run setup
          3. Application will auto-check for updates on next launch
          
          ### Option 2: Manual Installation
          1. Download the ZIP file above
          2. Extract to Program Files
          3. Run `DO.VIVICARE.UI.exe`
          
          ## Verify Integrity
          ```
          Checksum (SHA256):
          certutil -hashfile DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip SHA256
          ```
          
          **Expected:** See CHECKSUM.txt for expected value
          
          ## What's New
          - See RELEASE_NOTES.md in repository
          
          **Release Date:** 2026-01-24
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # JOB 3: RELEASE PLUGIN (solo se tag plugin/*)
  # ========================================
  release-plugin:
    needs: build-and-test
    if: startsWith(github.ref, 'refs/tags/plugin/')
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-output

    - name: Extract plugin info from tag
      id: plugin
      shell: powershell
      run: |
        $tag = "${{ github.ref }}"
        Write-Host "Processing tag: $tag"
        
        # Format: refs/tags/plugin/{plugin-id}/{version}
        if ($tag -match "refs/tags/plugin/([^/]+)/([^/]+)$") {
          $pluginId = $matches[1]
          $version = $matches[2]
          
          Write-Host "Plugin ID: $pluginId"
          Write-Host "Version: $version"
          
          # Map plugin ID to project folder
          $projectMap = @{
            "document.adialtaintensita" = "DO.VIVICARE.Document.ADIAltaIntensita"
            "document.adibassaintensita" = "DO.VIVICARE.Document.ADIBassaIntensita"
            "document.asst" = "DO.VIVICARE.Document.ASST"
            "document.comuni" = "DO.VIVICARE.Document.Comuni"
            "document.laziohealthworker" = "DO.VIVICARE.Document.LazioHealthWorker"
            "document.minsan" = "DO.VIVICARE.Document.MinSan"
            "document.prestazioni" = "DO.VIVICARE.Document.Prestazioni"
            "document.prezzi" = "DO.VIVICARE.Document.Prezzi"
            "document.rendiconto" = "DO.VIVICARE.Document.Rendiconto"
            "document.report16" = "DO.VIVICARE.Document.Report16"
            "document.report18" = "DO.VIVICARE.Document.Report18"
            "document.valorizzazione" = "DO.VIVICARE.Document.Valorizzazione"
            "document.valorizzazioniadialta" = "DO.VIVICARE.Document.ValorizzazioniADIAlta"
            "document.zsdfatture" = "DO.VIVICARE.Document.ZSDFatture"
            "report.allegatoadi" = "DO.VIVICARE.Report.AllegatoADI"
            "report.dietetica" = "DO.VIVICARE.Report.Dietetica"
            "report.valorizzazione" = "DO.VIVICARE.Report.Valorizzazione"
          }
          
          $projectName = $projectMap[$pluginId]
          
          if (-not $projectName) {
            Write-Error "Unknown plugin ID: $pluginId"
            exit 1
          }
          
          Write-Host "Project Name: $projectName"
          
          echo "pluginId=$pluginId" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "projectName=$projectName" >> $env:GITHUB_OUTPUT
        } else {
          Write-Error "Invalid tag format: $tag"
          exit 1
        }

    - name: Package plugin DLL
      shell: powershell
      run: |
        $projectName = "${{ steps.plugin.outputs.projectName }}"
        $version = "${{ steps.plugin.outputs.version }}"
        $dllPath = "$projectName/bin/Release/$projectName.dll"
        $outputName = "$projectName-$version.dll"
        
        Write-Host "Looking for DLL at: $dllPath"
        
        if (Test-Path $dllPath) {
          Copy-Item $dllPath -Destination $outputName
          Write-Host "Package created: $outputName"
        } else {
          Write-Error "DLL not found at: $dllPath"
          Get-ChildItem "$projectName/bin" -Recurse | Select-Object FullName
          exit 1
        }

    - name: Generate checksum
      shell: powershell
      run: |
        $projectName = "${{ steps.plugin.outputs.projectName }}"
        $version = "${{ steps.plugin.outputs.version }}"
        $fileName = "$projectName-$version.dll"
        
        $checksum = (Get-FileHash $fileName -Algorithm SHA256).Hash
        echo "$checksum  $fileName" | Out-File -Encoding ASCII "CHECKSUM.txt"
        Write-Host "Checksum: $checksum"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.plugin.outputs.projectName }}-${{ steps.plugin.outputs.version }}.dll
          CHECKSUM.txt
        body: |
          # Plugin: ${{ steps.plugin.outputs.projectName }}
          
          **Version**: ${{ steps.plugin.outputs.version }}
          
          ## Installation (In-App)
          
          1. Open **DO.VIVICARE UI**
          2. Go to **Tools â†’ Plugin Manager**
          3. Find this plugin in **Available Plugins**
          4. Click **Download**
          5. Ready! (no restart needed)
          
          ## Manual Installation
          
          1. Download the `.dll` file
          2. Place in: `C:\Program Files\DO.VIVICARE\Plugins\`
          3. Restart the application
          
          ## Verify Integrity
          ```
          certutil -hashfile ${{ steps.plugin.outputs.projectName }}-${{ steps.plugin.outputs.version }}.dll SHA256
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
