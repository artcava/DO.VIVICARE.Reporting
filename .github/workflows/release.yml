name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
      - 'plugin/*'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # JOB 1: Release APP (quando tag = v*.*.*)
  release-app:
    if: startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/plugin')
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from tag
      id: version
      shell: powershell
      run: |
        $tag = "${{ github.ref }}"
        if ($tag -match "refs/tags/v(.*)$") {
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT
        }

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Restore NuGet packages
      run: nuget restore DO.VIVICARE.Reporting.sln

    - name: Build UI and Reporter only
      run: |
        msbuild DO.VIVICARE.UI\DO.VIVICARE.UI.csproj /p:Configuration=Release /p:Platform="Any CPU"
        msbuild DO.VIVICARE.Reporter\DO.VIVICARE.Reporter.csproj /p:Configuration=Release /p:Platform="Any CPU"

    - name: Create application package
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # Create build directory
        New-Item -ItemType Directory -Force -Path "build\app" | Out-Null
        
        # Copy UI binaries
        Copy-Item "DO.VIVICARE.UI\bin\Release\*" -Destination "build\app\" -Force -Recurse
        Copy-Item "DO.VIVICARE.Reporter\bin\Release\*" -Destination "build\app\" -Force -Recurse
        
        # Create ZIP as installer package (MSI would require WiX Toolset)
        Write-Host "Creating application package..."
        Compress-Archive -Path "build\app\*" -DestinationPath "DO.VIVICARE-Setup-$version.zip" -Force
        Write-Host "Application package created: DO.VIVICARE-Setup-$version.zip"

    - name: Generate checksums
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $fileName = "DO.VIVICARE-Setup-$version.zip"
        
        $checksum = (Get-FileHash $fileName -Algorithm SHA256).Hash
        echo "$checksum  $fileName" | Out-File -Encoding ASCII "CHECKSUM.txt"
        Write-Host "Checksum generated: $checksum"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip
          CHECKSUM.txt
        body: |
          # DO.VIVICARE Reporting v${{ steps.version.outputs.version }}
          
          ## ðŸ“¦ What's Included
          - âœ… UI Application
          - âœ… Reporter Library
          - âœ… Plugin Manager (for automatic library updates)
          
          ## ðŸš€ Installation Instructions
          
          1. **Download** the `DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip` file
          2. **Extract** to your preferred location
          3. **Run** the setup process (installer or direct execution)
          4. **Follow** the setup wizard
          
          ## ðŸ“‹ First Steps After Installation
          
          Once installed, you can expand functionality:
          
          1. Open **DO.VIVICARE UI**
          2. Go to **Tools â†’ Plugin Manager**
          3. Browse available document and report modules
          4. Click **Download** to add modules (no restart needed!)
          
          ## ðŸ”’ Verify File Integrity
          
          Compare the SHA256 checksum:
          ```
          certutil -hashfile DO.VIVICARE-Setup-${{ steps.version.outputs.version }}.zip SHA256
          ```
          
          Should match the value in `CHECKSUM.txt`
          
          ## ðŸ“š Available Plugins
          
          ### Document Modules (13)
          - ADI Alta Intensita
          - ADI Bassa Intensita
          - ASST
          - Comuni
          - Lazio Health Worker
          - Ministero Sanita
          - Prestazioni
          - Prezzi
          - Rendiconto
          - Report 16
          - Report 18
          - Valorizzazione
          - ZSD Fatture
          
          ### Report Modules (3)
          - Allegato ADI
          - Dietetica
          - Valorizzazione
          
          ## ðŸ†š Version Information
          - **Application**: ${{ steps.version.outputs.version }}
          - **Framework**: .NET Framework 4.8+
          - **Release Date**: $(Get-Date -Format 'yyyy-MM-dd')
          
          ## ðŸ“– Documentation
          - See `INSTALLATION_GUIDE.md` for detailed setup instructions
          - See `CONTRIBUTING.md` for development guidelines
          
          ---
          **Thank you for using DO.VIVICARE Reporting!**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # JOB 2: Release PLUGIN (quando tag = plugin/*/version)
  release-plugin:
    if: startsWith(github.ref, 'refs/tags/plugin')
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract plugin info from tag
      id: plugin
      shell: powershell
      run: |
        $tag = "${{ github.ref }}"
        # Format: refs/tags/plugin/document.adialtaintensita/1.0.5
        if ($tag -match "refs/tags/plugin/([^/]+)/([^/]+)$") {
          $pluginId = $matches[1]
          $version = $matches[2]
          
          # Map plugin ID to project folder
          $projectMap = @{
            "document.adialtaintensita" = "DO.VIVICARE.Document.ADIAltaIntensita"
            "document.adibassaintensita" = "DO.VIVICARE.Document.ADIBassaIntensita"
            "document.asst" = "DO.VIVICARE.Document.ASST"
            "document.comuni" = "DO.VIVICARE.Document.Comuni"
            "document.laziohealthworker" = "DO.VIVICARE.Document.LazioHealthWorker"
            "document.minsan" = "DO.VIVICARE.Document.MinSan"
            "document.prestazioni" = "DO.VIVICARE.Document.Prestazioni"
            "document.prezzi" = "DO.VIVICARE.Document.Prezzi"
            "document.rendiconto" = "DO.VIVICARE.Document.Rendiconto"
            "document.report16" = "DO.VIVICARE.Document.Report16"
            "document.report18" = "DO.VIVICARE.Document.Report18"
            "document.valorizzazione" = "DO.VIVICARE.Document.Valorizzazione"
            "document.zsdfatture" = "DO.VIVICARE.Document.ZSDFatture"
            "report.allegatoadi" = "DO.VIVICARE.Report.AllegatoADI"
            "report.dietetica" = "DO.VIVICARE.Report.Dietetica"
            "report.valorizzazione" = "DO.VIVICARE.Report.Valorizzazione"
          }
          
          $projectName = $projectMap[$pluginId]
          
          echo "pluginId=$pluginId" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "projectName=$projectName" >> $env:GITHUB_OUTPUT
        }

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Restore NuGet packages
      run: nuget restore DO.VIVICARE.Reporting.sln

    - name: Build plugin project
      run: |
        msbuild "${{ steps.plugin.outputs.projectName }}\${{ steps.plugin.outputs.projectName }}.csproj" /p:Configuration=Release /p:Platform="Any CPU"

    - name: Package plugin DLL
      shell: powershell
      run: |
        $projectName = "${{ steps.plugin.outputs.projectName }}"
        $version = "${{ steps.plugin.outputs.version }}"
        $dllPath = "$projectName\bin\Release\$projectName.dll"
        $outputName = "$projectName-$version.dll"
        
        if (Test-Path $dllPath) {
          Copy-Item $dllPath -Destination $outputName
          Write-Host "Package created: $outputName"
        } else {
          Write-Error "DLL not found at $dllPath"
          exit 1
        }

    - name: Generate checksum
      shell: powershell
      run: |
        $projectName = "${{ steps.plugin.outputs.projectName }}"
        $version = "${{ steps.plugin.outputs.version }}"
        $fileName = "$projectName-$version.dll"
        
        $checksum = (Get-FileHash $fileName -Algorithm SHA256).Hash
        echo "$checksum  $fileName" | Out-File -Encoding ASCII "CHECKSUM.txt"

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.plugin.outputs.projectName }}-${{ steps.plugin.outputs.version }}.dll
          CHECKSUM.txt
        body: |
          # Plugin: ${{ steps.plugin.outputs.projectName }}
          
          Version: ${{ steps.plugin.outputs.version }}
          
          This plugin is automatically available in the Plugin Manager.
          
          ## ðŸ“¥ Installation (In-App)
          
          1. Open **DO.VIVICARE UI**
          2. Go to **Tools â†’ Plugin Manager**
          3. Find this plugin in the **Available Plugins** list
          4. Click **Download**
          5. âœ… Installation complete (no restart needed!)
          
          ## ðŸ“‹ Manual Installation (Advanced)
          
          If manual installation is required:
          
          1. Download the `.dll` file
          2. Place it in: `C:\Program Files\DO.VIVICARE\Plugins\`
          3. Restart the application
          
          ## âœ… Verify Integrity
          
          ```
          certutil -hashfile ${{ steps.plugin.outputs.projectName }}-${{ steps.plugin.outputs.version }}.dll SHA256
          ```
          
          Compare with `CHECKSUM.txt`
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
