name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from tag
      id: version
      shell: powershell
      run: |
        $tag = "${{ github.ref }}"
        if ($tag -match "refs/tags/v(.*)$") {
          $version = $matches[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "tag=v$version" >> $env:GITHUB_OUTPUT
        }

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Restore NuGet packages
      run: nuget restore DO.VIVICARE.Reporting.sln

    - name: Build solution
      run: msbuild DO.VIVICARE.Reporting.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Create artifacts directory
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path artifacts | Out-Null
        New-Item -ItemType Directory -Force -Path checksums | Out-Null

    - name: Package binaries
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        
        # Package UI
        $uiPath = "DO.VIVICARE.UI\bin\Release"
        if (Test-Path "$uiPath\DO.VIVICARE.UI.exe") {
          New-Item -ItemType Directory -Force -Path "artifacts\UI" | Out-Null
          Copy-Item "$uiPath\*" -Destination "artifacts\UI\" -Force -ErrorAction SilentlyContinue
          Compress-Archive -Path "artifacts\UI\*" -DestinationPath "artifacts\DO.VIVICARE.UI-$version.zip" -Force
        }
        
        # Package Reporter
        $reporterPath = "DO.VIVICARE.Reporter\bin\Release"
        if (Test-Path "$reporterPath\DO.VIVICARE.Reporter.dll") {
          New-Item -ItemType Directory -Force -Path "artifacts\Reporter" | Out-Null
          Copy-Item "$reporterPath\*" -Destination "artifacts\Reporter\" -Force -ErrorAction SilentlyContinue
          Compress-Archive -Path "artifacts\Reporter\*" -DestinationPath "artifacts\DO.VIVICARE.Reporter-$version.zip" -Force
        }
        
        # Package Document modules
        foreach ($module in @("DO.VIVICARE.Document.ADIAltaIntensita", "DO.VIVICARE.Document.ADIBassaIntensita", "DO.VIVICARE.Document.ASST")) {
          $modulePath = "$module\bin\Release"
          if (Test-Path "$modulePath\$module.dll") {
            New-Item -ItemType Directory -Force -Path "artifacts\$module" | Out-Null
            Copy-Item "$modulePath\*" -Destination "artifacts\$module\" -Force -ErrorAction SilentlyContinue
            Compress-Archive -Path "artifacts\$module\*" -DestinationPath "artifacts\$module-$version.zip" -Force
          }
        }
        
        # Package Report modules
        foreach ($module in @("DO.VIVICARE.Report.Dietetica", "DO.VIVICARE.Report.AllegatoADI", "DO.VIVICARE.Report.Valorizzazione")) {
          $modulePath = "$module\bin\Release"
          if (Test-Path "$modulePath\$module.dll") {
            New-Item -ItemType Directory -Force -Path "artifacts\$module" | Out-Null
            Copy-Item "$modulePath\*" -Destination "artifacts\$module\" -Force -ErrorAction SilentlyContinue
            Compress-Archive -Path "artifacts\$module\*" -DestinationPath "artifacts\$module-$version.zip" -Force
          }
        }

    - name: Generate checksums
      shell: powershell
      run: |
        $checksumFile = "checksums\CHECKSUM-SHA256.txt"
        $null = New-Item -ItemType File -Path $checksumFile -Force
        Get-ChildItem "artifacts\*.zip" -ErrorAction SilentlyContinue | ForEach-Object {
          $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
          "$hash  $($_.Name)" | Add-Content -Path $checksumFile
        }

    - name: Create Release
      shell: powershell
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $tag = "v$version"
        $owner = "${{ github.repository_owner }}"
        $repo = "${{ github.event.repository.name }}"
        $token = "${{ secrets.GITHUB_TOKEN }}"
        
        # Prepare release description
        $body = @"
Version $version - Build and Package Release

This is the official release of DO.VIVICARE.Reporting v$version

## Package Contents

- **UI Application**: DO.VIVICARE.UI-$version.zip
- **Reporter Library**: DO.VIVICARE.Reporter-$version.zip
- **Document Libraries**: ADIAltaIntensita, ADIBassaIntensita, ASST
- **Report Libraries**: Dietetica, AllegatoADI, Valorizzazione

## Installation

1. Download the desired ZIP file
2. Extract to your installation directory
3. Follow DEPLOYMENT.md for setup instructions

## Integrity Verification

All packages include SHA256 checksums in CHECKSUM-SHA256.txt
"@
        
        # Create release via REST API
        $headers = @{
            'Authorization' = "token $token"
            'Accept' = 'application/vnd.github.v3+json'
            'Content-Type' = 'application/json'
        }
        
        $releaseData = @{
            tag_name = $tag
            name = "Version $version"
            body = $body
            draft = $false
            prerelease = $false
            make_latest = "true"
        } | ConvertTo-Json
        
        $releaseUrl = "https://api.github.com/repos/$owner/$repo/releases"
        Write-Host "Creating release at: $releaseUrl"
        
        try {
            $response = Invoke-WebRequest -Uri $releaseUrl `
                -Method POST `
                -Headers $headers `
                -Body $releaseData `
                -ErrorAction Stop
            
            $releaseJson = $response.Content | ConvertFrom-Json
            $releaseId = $releaseJson.id
            Write-Host "Release created successfully with ID: $releaseId"
            
            # Upload artifacts
            $uploadUrl = "https://uploads.github.com/repos/$owner/$repo/releases/$releaseId/assets"
            
            Get-ChildItem "artifacts\*.zip" -ErrorAction SilentlyContinue | ForEach-Object {
                $filePath = $_.FullName
                $fileName = $_.Name
                Write-Host "Uploading: $fileName"
                
                $uploadHeaders = @{
                    'Authorization' = "token $token"
                    'Content-Type' = 'application/zip'
                }
                
                Invoke-WebRequest -Uri "$uploadUrl?name=$fileName" `
                    -Method POST `
                    -Headers $uploadHeaders `
                    -InFile $filePath `
                    -ErrorAction Stop | Out-Null
                
                Write-Host "Uploaded: $fileName"
            }
            
            # Upload checksums
            if (Test-Path "checksums\CHECKSUM-SHA256.txt") {
                Write-Host "Uploading: CHECKSUM-SHA256.txt"
                $checksumHeaders = @{
                    'Authorization' = "token $token"
                    'Content-Type' = 'text/plain'
                }
                
                Invoke-WebRequest -Uri "$uploadUrl?name=CHECKSUM-SHA256.txt" `
                    -Method POST `
                    -Headers $checksumHeaders `
                    -InFile "checksums\CHECKSUM-SHA256.txt" `
                    -ErrorAction Stop | Out-Null
                
                Write-Host "Uploaded: CHECKSUM-SHA256.txt"
            }
            
            Write-Host "Release created successfully!"
            Write-Host "URL: https://github.com/$owner/$repo/releases/tag/$tag"
        } catch {
            Write-Host "Error creating release: $_"
            exit 1
        }
